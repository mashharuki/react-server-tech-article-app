import{R as se,r as k}from"./react.h85BbI97.mjs";import{R as ge}from"./react-dom.BQ44fJeE.mjs";var b=[],y=[],Re=Uint8Array,j="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";for(var _=0,ke=j.length;_<ke;++_)b[_]=j[_],y[j.charCodeAt(_)]=_;y[45]=62;y[95]=63;function Te(s){var e=s.length;if(e%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var t=s.indexOf("=");t===-1&&(t=e);var r=t===e?0:4-t%4;return[t,r]}function Ae(s,e,t){return(e+t)*3/4-t}function L(s){var e,t=Te(s),r=t[0],n=t[1],i=new Re(Ae(s,r,n)),o=0,c=n>0?r-4:r,a;for(a=0;a<c;a+=4)e=y[s.charCodeAt(a)]<<18|y[s.charCodeAt(a+1)]<<12|y[s.charCodeAt(a+2)]<<6|y[s.charCodeAt(a+3)],i[o++]=e>>16&255,i[o++]=e>>8&255,i[o++]=e&255;return n===2&&(e=y[s.charCodeAt(a)]<<2|y[s.charCodeAt(a+1)]>>4,i[o++]=e&255),n===1&&(e=y[s.charCodeAt(a)]<<10|y[s.charCodeAt(a+1)]<<4|y[s.charCodeAt(a+2)]>>2,i[o++]=e>>8&255,i[o++]=e&255),i}function Ce(s){return b[s>>18&63]+b[s>>12&63]+b[s>>6&63]+b[s&63]}function _e(s,e,t){for(var r,n=[],i=e;i<t;i+=3)r=(s[i]<<16&16711680)+(s[i+1]<<8&65280)+(s[i+2]&255),n.push(Ce(r));return n.join("")}function Q(s){for(var e,t=s.length,r=t%3,n=[],i=16383,o=0,c=t-r;o<c;o+=i)n.push(_e(s,o,o+i>c?c:o+i));return r===1?(e=s[t-1],n.push(b[e>>2]+b[e<<4&63]+"==")):r===2&&(e=(s[t-2]<<8)+s[t-1],n.push(b[e>>10]+b[e>>4&63]+b[e<<2&63]+"=")),n.join("")}function S(s){if(s===void 0)return{};if(!ye(s))throw new Error(`The arguments to a Convex function must be an object. Received: ${s}`);return s}function Ie(s){if(typeof s>"u")throw new Error("Client created with undefined deployment address. If you used an environment variable, check that it's set.");if(typeof s!="string")throw new Error(`Invalid deployment address: found ${s}".`);if(!(s.startsWith("http:")||s.startsWith("https:")))throw new Error(`Invalid deployment address: Must start with "https://" or "http://". Found "${s}".`);try{new URL(s)}catch{throw new Error(`Invalid deployment address: "${s}" is not a valid URL. If you believe this URL is correct, use the \`skipConvexDeploymentUrlCheck\` option to bypass this.`)}if(s.endsWith(".convex.site"))throw new Error(`Invalid deployment address: "${s}" ends with .convex.site, which is used for HTTP Actions. Convex deployment URLs typically end with .convex.cloud? If you believe this URL is correct, use the \`skipConvexDeploymentUrlCheck\` option to bypass this.`)}function ye(s){const e=typeof s=="object",t=Object.getPrototypeOf(s),r=t===null||t===Object.prototype||t?.constructor?.name==="Object";return e&&r}const pe=!0,O=BigInt("-9223372036854775808"),re=BigInt("9223372036854775807"),Y=BigInt("0"),Oe=BigInt("8"),Me=BigInt("256");function me(s){return Number.isNaN(s)||!Number.isFinite(s)||Object.is(s,-0)}function xe(s){s<Y&&(s-=O+O);let e=s.toString(16);e.length%2===1&&(e="0"+e);const t=new Uint8Array(new ArrayBuffer(8));let r=0;for(const n of e.match(/.{2}/g).reverse())t.set([parseInt(n,16)],r++),s>>=Oe;return Q(t)}function $e(s){const e=L(s);if(e.byteLength!==8)throw new Error(`Received ${e.byteLength} bytes, expected 8 for $integer`);let t=Y,r=Y;for(const n of e)t+=BigInt(n)*Me**r,r++;return t>re&&(t+=O+O),t}function Ee(s){if(s<O||re<s)throw new Error(`BigInt ${s} does not fit into a 64-bit signed integer.`);const e=new ArrayBuffer(8);return new DataView(e).setBigInt64(0,s,!0),Q(new Uint8Array(e))}function Le(s){const e=L(s);if(e.byteLength!==8)throw new Error(`Received ${e.byteLength} bytes, expected 8 for $integer`);return new DataView(e.buffer).getBigInt64(0,!0)}const Qe=DataView.prototype.setBigInt64?Ee:xe,Pe=DataView.prototype.getBigInt64?Le:$e,ne=1024;function we(s){if(s.length>ne)throw new Error(`Field name ${s} exceeds maximum field name length ${ne}.`);if(s.startsWith("$"))throw new Error(`Field name ${s} starts with a '$', which is reserved.`);for(let e=0;e<s.length;e+=1){const t=s.charCodeAt(e);if(t<32||t>=127)throw new Error(`Field name ${s} has invalid character '${s[e]}': Field names can only contain non-control ASCII characters`)}}function M(s){if(s===null||typeof s=="boolean"||typeof s=="number"||typeof s=="string")return s;if(Array.isArray(s))return s.map(r=>M(r));if(typeof s!="object")throw new Error(`Unexpected type of ${s}`);const e=Object.entries(s);if(e.length===1){const r=e[0][0];if(r==="$bytes"){if(typeof s.$bytes!="string")throw new Error(`Malformed $bytes field on ${s}`);return L(s.$bytes).buffer}if(r==="$integer"){if(typeof s.$integer!="string")throw new Error(`Malformed $integer field on ${s}`);return Pe(s.$integer)}if(r==="$float"){if(typeof s.$float!="string")throw new Error(`Malformed $float field on ${s}`);const n=L(s.$float);if(n.byteLength!==8)throw new Error(`Received ${n.byteLength} bytes, expected 8 for $float`);const o=new DataView(n.buffer).getFloat64(0,pe);if(!me(o))throw new Error(`Float ${o} should be encoded as a number`);return o}if(r==="$set")throw new Error("Received a Set which is no longer supported as a Convex type.");if(r==="$map")throw new Error("Received a Map which is no longer supported as a Convex type.")}const t={};for(const[r,n]of Object.entries(s))we(r),t[r]=M(n);return t}function $(s){return JSON.stringify(s,(e,t)=>t===void 0?"undefined":typeof t=="bigint"?`${t.toString()}n`:t)}function Z(s,e,t,r){if(s===void 0){const o=t&&` (present at path ${t} in original object ${$(e)})`;throw new Error(`undefined is not a valid Convex value${o}. To learn about Convex's supported types, see https://docs.convex.dev/using/types.`)}if(s===null)return s;if(typeof s=="bigint"){if(s<O||re<s)throw new Error(`BigInt ${s} does not fit into a 64-bit signed integer.`);return{$integer:Qe(s)}}if(typeof s=="number")if(me(s)){const o=new ArrayBuffer(8);return new DataView(o).setFloat64(0,s,pe),{$float:Q(new Uint8Array(o))}}else return s;if(typeof s=="boolean"||typeof s=="string")return s;if(s instanceof ArrayBuffer)return{$bytes:Q(new Uint8Array(s))};if(Array.isArray(s))return s.map((o,c)=>Z(o,e,t+`[${c}]`));if(s instanceof Set)throw new Error(J(t,"Set",[...s],e));if(s instanceof Map)throw new Error(J(t,"Map",[...s],e));if(!ye(s)){const o=s?.constructor?.name,c=o?`${o} `:"";throw new Error(J(t,c,s,e))}const n={},i=Object.entries(s);i.sort(([o,c],[a,d])=>o===a?0:o<a?-1:1);for(const[o,c]of i)c!==void 0&&(we(o),n[o]=Z(c,e,t+`.${o}`));return n}function J(s,e,t,r){return s?`${e}${$(t)} is not a supported Convex type (present at path ${s} in original object ${$(r)}). To learn about Convex's supported types, see https://docs.convex.dev/using/types.`:`${e}${$(t)} is not a supported Convex type.`}function T(s){return Z(s,s,"")}var Ve=Object.defineProperty,Fe=(s,e,t)=>e in s?Ve(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,H=(s,e,t)=>Fe(s,typeof e!="symbol"?e+"":e,t),ie,oe;const Ne=Symbol.for("ConvexError");class K extends(oe=Error,ie=Ne,oe){constructor(e){super(typeof e=="string"?e:$(e)),H(this,"name","ConvexError"),H(this,"data"),H(this,ie,!0),this.data=e}}const ae="1.19.0";var Be=Object.defineProperty,Ue=(s,e,t)=>e in s?Be(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,ce=(s,e,t)=>Ue(s,typeof e!="symbol"?e+"":e,t);const De="color:rgb(0, 145, 255)";function be(s){switch(s){case"query":return"Q";case"mutation":return"M";case"action":return"A";case"any":return"?"}}class We{constructor(e){ce(this,"_onLogLineFuncs"),ce(this,"_verbose"),this._onLogLineFuncs={},this._verbose=e.verbose}addLogLineListener(e){let t=Math.random().toString(36).substring(2,15);for(let r=0;r<10&&this._onLogLineFuncs[t]!==void 0;r++)t=Math.random().toString(36).substring(2,15);return this._onLogLineFuncs[t]=e,()=>{delete this._onLogLineFuncs[t]}}logVerbose(...e){if(this._verbose)for(const t of Object.values(this._onLogLineFuncs))t("debug",`${new Date().toISOString()}`,...e)}log(...e){for(const t of Object.values(this._onLogLineFuncs))t("info",...e)}warn(...e){for(const t of Object.values(this._onLogLineFuncs))t("warn",...e)}error(...e){for(const t of Object.values(this._onLogLineFuncs))t("error",...e)}}function ve(s){const e=new We(s);return e.addLogLineListener((t,...r)=>{switch(t){case"debug":console.debug(...r);break;case"info":console.log(...r);break;case"warn":console.warn(...r);break;case"error":console.error(...r);break;default:console.log(...r)}}),e}function N(s,e,t,r,n){const i=be(t);if(typeof n=="object"&&(n=`ConvexError ${JSON.stringify(n.errorData,null,2)}`),e==="info"){const o=n.match(/^\[.*?\] /);if(o===null){s.error(`[CONVEX ${i}(${r})] Could not parse console.log`);return}const c=n.slice(1,o[0].length-2),a=n.slice(o[0].length);s.log(`%c[CONVEX ${i}(${r})] [${c}]`,De,a)}else s.error(`[CONVEX ${i}(${r})] ${n}`)}function je(s,e){const t=`[CONVEX FATAL ERROR] ${e}`;return s.error(t),new Error(t)}function I(s,e,t){return`[CONVEX ${be(s)}(${e})] ${t.errorMessage}
  Called by client`}function ee(s,e){return e.data=s.errorData,e}function B(s){const e=s.split(":");let t,r;return e.length===1?(t=e[0],r="default"):(t=e.slice(0,e.length-1).join(":"),r=e[e.length-1]),t.endsWith(".js")&&(t=t.slice(0,-3)),`${t}:${r}`}function C(s,e){return JSON.stringify({udfPath:B(s),args:T(e)})}var Je=Object.defineProperty,He=(s,e,t)=>e in s?Je(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,w=(s,e,t)=>He(s,typeof e!="symbol"?e+"":e,t);class ze{constructor(){w(this,"nextQueryId"),w(this,"querySetVersion"),w(this,"querySet"),w(this,"queryIdToToken"),w(this,"identityVersion"),w(this,"auth"),w(this,"outstandingQueriesOlderThanRestart"),w(this,"outstandingAuthOlderThanRestart"),w(this,"paused"),w(this,"pendingQuerySetModifications"),this.nextQueryId=0,this.querySetVersion=0,this.identityVersion=0,this.querySet=new Map,this.queryIdToToken=new Map,this.outstandingQueriesOlderThanRestart=new Set,this.outstandingAuthOlderThanRestart=!1,this.paused=!1,this.pendingQuerySetModifications=new Map}hasSyncedPastLastReconnect(){return this.outstandingQueriesOlderThanRestart.size===0&&!this.outstandingAuthOlderThanRestart}markAuthCompletion(){this.outstandingAuthOlderThanRestart=!1}subscribe(e,t,r,n){const i=B(e),o=C(i,t),c=this.querySet.get(o);if(c!==void 0)return c.numSubscribers+=1,{queryToken:o,modification:null,unsubscribe:()=>this.removeSubscriber(o)};{const a=this.nextQueryId++,d={id:a,canonicalizedUdfPath:i,args:t,numSubscribers:1,journal:r,componentPath:n};this.querySet.set(o,d),this.queryIdToToken.set(a,o);const v=this.querySetVersion,A=this.querySetVersion+1,u={type:"Add",queryId:a,udfPath:i,args:[T(t)],journal:r,componentPath:n};return this.paused?this.pendingQuerySetModifications.set(a,u):this.querySetVersion=A,{queryToken:o,modification:{type:"ModifyQuerySet",baseVersion:v,newVersion:A,modifications:[u]},unsubscribe:()=>this.removeSubscriber(o)}}}transition(e){for(const t of e.modifications)switch(t.type){case"QueryUpdated":case"QueryFailed":{this.outstandingQueriesOlderThanRestart.delete(t.queryId);const r=t.journal;if(r!==void 0){const n=this.queryIdToToken.get(t.queryId);n!==void 0&&(this.querySet.get(n).journal=r)}break}case"QueryRemoved":{this.outstandingQueriesOlderThanRestart.delete(t.queryId);break}default:throw new Error(`Invalid modification ${t.type}`)}}queryId(e,t){const r=B(e),n=C(r,t),i=this.querySet.get(n);return i!==void 0?i.id:null}isCurrentOrNewerAuthVersion(e){return e>=this.identityVersion}setAuth(e){this.auth={tokenType:"User",value:e};const t=this.identityVersion;return this.paused||(this.identityVersion=t+1),{type:"Authenticate",baseVersion:t,...this.auth}}setAdminAuth(e,t){const r={tokenType:"Admin",value:e,impersonating:t};this.auth=r;const n=this.identityVersion;return this.paused||(this.identityVersion=n+1),{type:"Authenticate",baseVersion:n,...r}}clearAuth(){this.auth=void 0,this.markAuthCompletion();const e=this.identityVersion;return this.paused||(this.identityVersion=e+1),{type:"Authenticate",tokenType:"None",baseVersion:e}}hasAuth(){return!!this.auth}isNewAuth(e){return this.auth?.value!==e}queryPath(e){const t=this.queryIdToToken.get(e);return t?this.querySet.get(t).canonicalizedUdfPath:null}queryArgs(e){const t=this.queryIdToToken.get(e);return t?this.querySet.get(t).args:null}queryToken(e){return this.queryIdToToken.get(e)??null}queryJournal(e){return this.querySet.get(e)?.journal}restart(e){this.unpause(),this.outstandingQueriesOlderThanRestart.clear();const t=[];for(const i of this.querySet.values()){const o={type:"Add",queryId:i.id,udfPath:i.canonicalizedUdfPath,args:[T(i.args)],journal:i.journal,componentPath:i.componentPath};t.push(o),e.has(i.id)||this.outstandingQueriesOlderThanRestart.add(i.id)}this.querySetVersion=1;const r={type:"ModifyQuerySet",baseVersion:0,newVersion:1,modifications:t};if(!this.auth)return this.identityVersion=0,[r,void 0];this.outstandingAuthOlderThanRestart=!0;const n={type:"Authenticate",baseVersion:0,...this.auth};return this.identityVersion=1,[r,n]}pause(){this.paused=!0}resume(){const e=this.pendingQuerySetModifications.size>0?{type:"ModifyQuerySet",baseVersion:this.querySetVersion,newVersion:++this.querySetVersion,modifications:Array.from(this.pendingQuerySetModifications.values())}:void 0,t=this.auth!==void 0?{type:"Authenticate",baseVersion:this.identityVersion++,...this.auth}:void 0;return this.unpause(),[e,t]}unpause(){this.paused=!1,this.pendingQuerySetModifications.clear()}removeSubscriber(e){const t=this.querySet.get(e);if(t.numSubscribers>1)return t.numSubscribers-=1,null;{this.querySet.delete(e),this.queryIdToToken.delete(t.id),this.outstandingQueriesOlderThanRestart.delete(t.id);const r=this.querySetVersion,n=this.querySetVersion+1,i={type:"Remove",queryId:t.id};return this.paused?this.pendingQuerySetModifications.has(t.id)?this.pendingQuerySetModifications.delete(t.id):this.pendingQuerySetModifications.set(t.id,i):this.querySetVersion=n,{type:"ModifyQuerySet",baseVersion:r,newVersion:n,modifications:[i]}}}}var Xe=Object.defineProperty,Ge=(s,e,t)=>e in s?Xe(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,ue=(s,e,t)=>Ge(s,typeof e!="symbol"?e+"":e,t);class Ye{constructor(e){this.logger=e,ue(this,"inflightRequests"),ue(this,"requestsOlderThanRestart"),this.inflightRequests=new Map,this.requestsOlderThanRestart=new Set}request(e,t){return new Promise(n=>{const i=t?"Requested":"NotSent";this.inflightRequests.set(e.requestId,{message:e,status:{status:i,requestedAt:new Date,onResult:n}})})}onResponse(e){const t=this.inflightRequests.get(e.requestId);if(t===void 0||t.status.status==="Completed")return null;const r=t.message.type==="Mutation"?"mutation":"action",n=t.message.udfPath;for(const a of e.logLines)N(this.logger,"info",r,n,a);const i=t.status;let o,c;if(e.success)o={success:!0,logLines:e.logLines,value:M(e.result)},c=()=>i.onResult(o);else{const a=e.result,{errorData:d}=e;N(this.logger,"error",r,n,a),o={success:!1,errorMessage:a,errorData:d!==void 0?M(d):void 0,logLines:e.logLines},c=()=>i.onResult(o)}return e.type==="ActionResponse"||!e.success?(c(),this.inflightRequests.delete(e.requestId),this.requestsOlderThanRestart.delete(e.requestId),{requestId:e.requestId,result:o}):(t.status={status:"Completed",result:o,ts:e.ts,onResolve:c},null)}removeCompleted(e){const t=new Map;for(const[r,n]of this.inflightRequests.entries()){const i=n.status;i.status==="Completed"&&i.ts.lessThanOrEqual(e)&&(i.onResolve(),t.set(r,i.result),this.inflightRequests.delete(r),this.requestsOlderThanRestart.delete(r))}return t}restart(){this.requestsOlderThanRestart=new Set(this.inflightRequests.keys());const e=[];for(const[t,r]of this.inflightRequests){if(r.status.status==="NotSent"){r.status.status="Requested",e.push(r.message);continue}if(r.message.type==="Mutation")e.push(r.message);else{if(this.inflightRequests.delete(t),this.requestsOlderThanRestart.delete(t),r.status.status==="Completed")throw new Error("Action should never be in 'Completed' state");r.status.onResult({success:!1,errorMessage:"Connection lost while action was in flight",logLines:[]})}}return e}resume(){const e=[];for(const[,t]of this.inflightRequests)if(t.status.status==="NotSent"){t.status.status="Requested",e.push(t.message);continue}return e}hasIncompleteRequests(){for(const e of this.inflightRequests.values())if(e.status.status==="Requested")return!0;return!1}hasInflightRequests(){return this.inflightRequests.size>0}hasSyncedPastLastReconnect(){return this.requestsOlderThanRestart.size===0}timeOfOldestInflightRequest(){if(this.inflightRequests.size===0)return null;let e=Date.now();for(const t of this.inflightRequests.values())t.status.status!=="Completed"&&t.status.requestedAt.getTime()<e&&(e=t.status.requestedAt.getTime());return new Date(e)}}const P=Symbol.for("functionName"),Ze=Symbol.for("toReferencePath");function Ke(s){return s[Ze]??null}function et(s){return s.startsWith("function://")}function tt(s){let e;if(typeof s=="string")et(s)?e={functionHandle:s}:e={name:s};else if(s[P])e={name:s[P]};else{const t=Ke(s);if(!t)throw new Error(`${s} is not a functionReference`);e={reference:t}}return e}function m(s){const e=tt(s);if(e.name===void 0)throw e.functionHandle!==void 0?new Error(`Expected function reference like "api.file.func" or "internal.file.func", but received function handle ${e.functionHandle}`):e.reference!==void 0?new Error(`Expected function reference in the current component like "api.file.func" or "internal.file.func", but received reference ${e.reference}`):new Error(`Expected function reference like "api.file.func" or "internal.file.func", but received ${JSON.stringify(e)}`);if(typeof s=="string")return s;const t=s[P];if(!t)throw new Error(`${s} is not a functionReference`);return t}function st(s){return{[P]:s}}function Se(s=[]){const e={get(t,r){if(typeof r=="string"){const n=[...s,r];return Se(n)}else if(r===P){if(s.length<2){const o=["api",...s].join(".");throw new Error(`API path is expected to be of the form \`api.moduleName.functionName\`. Found: \`${o}\``)}const n=s.slice(0,-1).join("/"),i=s[s.length-1];return i==="default"?n:n+":"+i}else return r===Symbol.toStringTag?"FunctionReference":void 0}};return new Proxy({},e)}const zt=Se();var rt=Object.defineProperty,nt=(s,e,t)=>e in s?rt(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,U=(s,e,t)=>nt(s,typeof e!="symbol"?e+"":e,t);class V{constructor(e){U(this,"queryResults"),U(this,"modifiedQueries"),this.queryResults=e,this.modifiedQueries=[]}getQuery(e,...t){const r=S(t[0]),n=m(e),i=this.queryResults.get(C(n,r));if(i!==void 0)return V.queryValue(i.result)}getAllQueries(e){const t=[],r=m(e);for(const n of this.queryResults.values())n.udfPath===B(r)&&t.push({args:n.args,value:V.queryValue(n.result)});return t}setQuery(e,t,r){const n=S(t),i=m(e),o=C(i,n);let c;r===void 0?c=void 0:c={success:!0,value:r,logLines:[]};const a={udfPath:i,args:n,result:c};this.queryResults.set(o,a),this.modifiedQueries.push(o)}static queryValue(e){if(e!==void 0)return e.success?e.value:void 0}}class it{constructor(){U(this,"queryResults"),U(this,"optimisticUpdates"),this.queryResults=new Map,this.optimisticUpdates=[]}ingestQueryResultsFromServer(e,t){this.optimisticUpdates=this.optimisticUpdates.filter(o=>!t.has(o.mutationId));const r=this.queryResults;this.queryResults=new Map(e);const n=new V(this.queryResults);for(const o of this.optimisticUpdates)o.update(n);const i=[];for(const[o,c]of this.queryResults){const a=r.get(o);(a===void 0||a.result!==c.result)&&i.push(o)}return i}applyOptimisticUpdate(e,t){this.optimisticUpdates.push({update:e,mutationId:t});const r=new V(this.queryResults);return e(r),r.modifiedQueries}queryResult(e){const t=this.queryResults.get(e);if(t===void 0)return;const r=t.result;if(r!==void 0){if(r.success)return r.value;throw r.errorData!==void 0?ee(r,new K(I("query",t.udfPath,r))):new Error(I("query",t.udfPath,r))}}hasQueryResult(e){return this.queryResults.get(e)!==void 0}queryLogs(e){return this.queryResults.get(e)?.result?.logLines}}var ot=Object.defineProperty,at=(s,e,t)=>e in s?ot(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,z=(s,e,t)=>at(s,typeof e!="symbol"?e+"":e,t);class g{constructor(e,t){z(this,"low"),z(this,"high"),z(this,"__isUnsignedLong__"),this.low=e|0,this.high=t|0,this.__isUnsignedLong__=!0}static isLong(e){return(e&&e.__isUnsignedLong__)===!0}static fromBytesLE(e){return new g(e[0]|e[1]<<8|e[2]<<16|e[3]<<24,e[4]|e[5]<<8|e[6]<<16|e[7]<<24)}toBytesLE(){const e=this.high,t=this.low;return[t&255,t>>>8&255,t>>>16&255,t>>>24,e&255,e>>>8&255,e>>>16&255,e>>>24]}static fromNumber(e){return isNaN(e)||e<0?he:e>=ct?ut:new g(e%E|0,e/E|0)}toString(){return(BigInt(this.high)*BigInt(E)+BigInt(this.low)).toString()}equals(e){return g.isLong(e)||(e=g.fromValue(e)),this.high>>>31===1&&e.high>>>31===1?!1:this.high===e.high&&this.low===e.low}notEquals(e){return!this.equals(e)}comp(e){return g.isLong(e)||(e=g.fromValue(e)),this.equals(e)?0:e.high>>>0>this.high>>>0||e.high===this.high&&e.low>>>0>this.low>>>0?-1:1}lessThanOrEqual(e){return this.comp(e)<=0}static fromValue(e){return typeof e=="number"?g.fromNumber(e):new g(e.low,e.high)}}const he=new g(0,0),de=65536,E=de*de,ct=E*E,ut=new g(-1,-1);var ht=Object.defineProperty,dt=(s,e,t)=>e in s?ht(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,F=(s,e,t)=>dt(s,typeof e!="symbol"?e+"":e,t);class le{constructor(e,t){F(this,"version"),F(this,"remoteQuerySet"),F(this,"queryPath"),F(this,"logger"),this.version={querySet:0,ts:g.fromNumber(0),identity:0},this.remoteQuerySet=new Map,this.queryPath=e,this.logger=t}transition(e){const t=e.startVersion;if(this.version.querySet!==t.querySet||this.version.ts.notEquals(t.ts)||this.version.identity!==t.identity)throw new Error(`Invalid start version: ${t.ts.toString()}:${t.querySet}`);for(const r of e.modifications)switch(r.type){case"QueryUpdated":{const n=this.queryPath(r.queryId);if(n)for(const o of r.logLines)N(this.logger,"info","query",n,o);const i=M(r.value??null);this.remoteQuerySet.set(r.queryId,{success:!0,value:i,logLines:r.logLines});break}case"QueryFailed":{const n=this.queryPath(r.queryId);if(n)for(const o of r.logLines)N(this.logger,"info","query",n,o);const{errorData:i}=r;this.remoteQuerySet.set(r.queryId,{success:!1,errorMessage:r.errorMessage,errorData:i!==void 0?M(i):void 0,logLines:r.logLines});break}case"QueryRemoved":{this.remoteQuerySet.delete(r.queryId);break}default:throw new Error(`Invalid modification ${r.type}`)}this.version=e.endVersion}remoteQueryResults(){return this.remoteQuerySet}timestamp(){return this.version.ts}}function X(s){const e=L(s);return g.fromBytesLE(Array.from(e))}function lt(s){const e=new Uint8Array(s.toBytesLE());return Q(e)}function ft(s){switch(s.type){case"FatalError":case"AuthError":case"ActionResponse":case"Ping":return{...s};case"MutationResponse":return s.success?{...s,ts:X(s.ts)}:{...s};case"Transition":return{...s,startVersion:{...s.startVersion,ts:X(s.startVersion.ts)},endVersion:{...s.endVersion,ts:X(s.endVersion.ts)}}}}function gt(s){switch(s.type){case"Authenticate":case"ModifyQuerySet":case"Mutation":case"Action":case"Event":return{...s};case"Connect":return s.maxObservedTimestamp!==void 0?{...s,maxObservedTimestamp:lt(s.maxObservedTimestamp)}:{...s,maxObservedTimestamp:void 0}}}var yt=Object.defineProperty,pt=(s,e,t)=>e in s?yt(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,f=(s,e,t)=>pt(s,typeof e!="symbol"?e+"":e,t);const mt=1e3,wt=1001,bt=1005,vt=4040;class St{constructor(e,t,r,n){f(this,"socket"),f(this,"connectionCount"),f(this,"lastCloseReason"),f(this,"initialBackoff"),f(this,"maxBackoff"),f(this,"retries"),f(this,"serverInactivityThreshold"),f(this,"reconnectDueToServerInactivityTimeout"),f(this,"uri"),f(this,"onOpen"),f(this,"onResume"),f(this,"onMessage"),f(this,"webSocketConstructor"),f(this,"logger"),this.webSocketConstructor=r,this.socket={state:"disconnected"},this.connectionCount=0,this.lastCloseReason="InitialConnect",this.initialBackoff=100,this.maxBackoff=16e3,this.retries=0,this.serverInactivityThreshold=3e4,this.reconnectDueToServerInactivityTimeout=null,this.uri=e,this.onOpen=t.onOpen,this.onResume=t.onResume,this.onMessage=t.onMessage,this.logger=n,this.connect()}connect(){if(this.socket.state==="terminated")return;if(this.socket.state!=="disconnected"&&this.socket.state!=="stopped")throw new Error("Didn't start connection from disconnected state: "+this.socket.state);const e=new this.webSocketConstructor(this.uri);this._logVerbose("constructed WebSocket"),this.socket={state:"connecting",ws:e,paused:"no"},this.resetServerInactivityTimeout(),e.onopen=()=>{if(this.logger.logVerbose("begin ws.onopen"),this.socket.state!=="connecting")throw new Error("onopen called with socket not in connecting state");this.socket={state:"ready",ws:e,paused:this.socket.paused==="yes"?"uninitialized":"no"},this.resetServerInactivityTimeout(),this.socket.paused==="no"&&this.onOpen({connectionCount:this.connectionCount,lastCloseReason:this.lastCloseReason}),this.lastCloseReason!=="InitialConnect"&&this.logger.log("WebSocket reconnected"),this.connectionCount+=1,this.lastCloseReason=null},e.onerror=t=>{const r=t.message;this.logger.log(`WebSocket error: ${r}`)},e.onmessage=t=>{this.resetServerInactivityTimeout();const r=ft(JSON.parse(t.data));this._logVerbose(`received ws message with type ${r.type}`),this.onMessage(r).hasSyncedPastLastReconnect&&(this.retries=0)},e.onclose=t=>{if(this._logVerbose("begin ws.onclose"),this.lastCloseReason===null&&(this.lastCloseReason=t.reason??"OnCloseInvoked"),t.code!==mt&&t.code!==wt&&t.code!==bt&&t.code!==vt){let r=`WebSocket closed with code ${t.code}`;t.reason&&(r+=`: ${t.reason}`),this.logger.log(r)}this.scheduleReconnect()}}socketState(){return this.socket.state}sendMessage(e){if(this._logVerbose(`sending message with type ${e.type}`),this.socket.state==="ready"&&this.socket.paused==="no"){const t=gt(e),r=JSON.stringify(t);try{this.socket.ws.send(r)}catch(n){this.logger.log(`Failed to send message on WebSocket, reconnecting: ${n}`),this.closeAndReconnect("FailedToSendMessage")}return!0}return!1}resetServerInactivityTimeout(){this.socket.state!=="terminated"&&(this.reconnectDueToServerInactivityTimeout!==null&&(clearTimeout(this.reconnectDueToServerInactivityTimeout),this.reconnectDueToServerInactivityTimeout=null),this.reconnectDueToServerInactivityTimeout=setTimeout(()=>{this.closeAndReconnect("InactiveServer")},this.serverInactivityThreshold))}scheduleReconnect(){this.socket={state:"disconnected"};const e=this.nextBackoff();this.logger.log(`Attempting reconnect in ${e}ms`),setTimeout(()=>this.connect(),e)}closeAndReconnect(e){switch(this._logVerbose(`begin closeAndReconnect with reason ${e}`),this.socket.state){case"disconnected":case"terminated":case"stopped":return;case"connecting":case"ready":{this.lastCloseReason=e,this.close(),this.scheduleReconnect();return}default:this.socket}}close(){switch(this.socket.state){case"disconnected":case"terminated":case"stopped":return Promise.resolve();case"connecting":{const e=this.socket.ws;return new Promise(t=>{e.onclose=()=>{this._logVerbose("Closed after connecting"),t()},e.onopen=()=>{this._logVerbose("Opened after connecting"),e.close()}})}case"ready":{this._logVerbose("ws.close called");const e=this.socket.ws,t=new Promise(r=>{e.onclose=()=>{r()}});return e.close(),t}default:return this.socket,Promise.resolve()}}terminate(){switch(this.reconnectDueToServerInactivityTimeout&&clearTimeout(this.reconnectDueToServerInactivityTimeout),this.socket.state){case"terminated":case"stopped":case"disconnected":case"connecting":case"ready":{const e=this.close();return this.socket={state:"terminated"},e}default:throw this.socket,new Error(`Invalid websocket state: ${this.socket.state}`)}}stop(){switch(this.socket.state){case"terminated":return Promise.resolve();case"connecting":case"stopped":case"disconnected":case"ready":{const e=this.close();return this.socket={state:"stopped"},e}default:return this.socket,Promise.resolve()}}restart(){switch(this.socket.state){case"stopped":break;case"terminated":return;case"connecting":case"ready":case"disconnected":throw new Error("`restart()` is only valid after `stop()`");default:this.socket}this.connect()}pause(){switch(this.socket.state){case"disconnected":case"stopped":case"terminated":return;case"connecting":case"ready":{this.socket={...this.socket,paused:"yes"};return}default:{this.socket;return}}}resume(){switch(this.socket.state){case"connecting":this.socket={...this.socket,paused:"no"};return;case"ready":this.socket.paused==="uninitialized"?(this.socket={...this.socket,paused:"no"},this.onOpen({connectionCount:this.connectionCount,lastCloseReason:this.lastCloseReason})):this.socket.paused==="yes"&&(this.socket={...this.socket,paused:"no"},this.onResume());return;case"terminated":case"stopped":case"disconnected":return;default:this.socket}this.connect()}_logVerbose(e){this.logger.logVerbose(e)}nextBackoff(){const e=this.initialBackoff*Math.pow(2,this.retries);this.retries+=1;const t=Math.min(e,this.maxBackoff),r=t*(Math.random()-.5);return t+r}}function qt(){return Rt()}function Rt(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,s=>{const e=Math.random()*16|0;return(s==="x"?e:e&3|8).toString(16)})}function te(s){this.message=s}te.prototype=new Error,te.prototype.name="InvalidCharacterError";var fe=typeof window<"u"&&window.atob&&window.atob.bind(window)||function(s){var e=String(s).replace(/=+$/,"");if(e.length%4==1)throw new te("'atob' failed: The string to be decoded is not correctly encoded.");for(var t,r,n=0,i=0,o="";r=e.charAt(i++);~r&&(t=n%4?64*t+r:r,n++%4)?o+=String.fromCharCode(255&t>>(-2*n&6)):0)r="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".indexOf(r);return o};function kt(s){var e=s.replace(/-/g,"+").replace(/_/g,"/");switch(e.length%4){case 0:break;case 2:e+="==";break;case 3:e+="=";break;default:throw"Illegal base64url string!"}try{return function(t){return decodeURIComponent(fe(t).replace(/(.)/g,function(r,n){var i=n.charCodeAt(0).toString(16).toUpperCase();return i.length<2&&(i="0"+i),"%"+i}))}(e)}catch{return fe(e)}}function D(s){this.message=s}function Tt(s,e){if(typeof s!="string")throw new D("Invalid token specified");var t=(e=e||{}).header===!0?0:1;try{return JSON.parse(kt(s.split(".")[t]))}catch(r){throw new D("Invalid token specified: "+r.message)}}D.prototype=new Error,D.prototype.name="InvalidTokenError";var At=Object.defineProperty,Ct=(s,e,t)=>e in s?At(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,p=(s,e,t)=>Ct(s,typeof e!="symbol"?e+"":e,t);const _t=20*24*60*60*1e3;class It{constructor(e,t,r){p(this,"authState",{state:"noAuth"}),p(this,"configVersion",0),p(this,"syncState"),p(this,"authenticate"),p(this,"stopSocket"),p(this,"restartSocket"),p(this,"pauseSocket"),p(this,"resumeSocket"),p(this,"clearAuth"),p(this,"logger"),p(this,"refreshTokenLeewaySeconds"),this.syncState=e,this.authenticate=t.authenticate,this.stopSocket=t.stopSocket,this.restartSocket=t.restartSocket,this.pauseSocket=t.pauseSocket,this.resumeSocket=t.resumeSocket,this.clearAuth=t.clearAuth,this.logger=r.logger,this.refreshTokenLeewaySeconds=r.refreshTokenLeewaySeconds}async setConfig(e,t){this.resetAuthState(),this._logVerbose("pausing WS for auth token fetch"),this.pauseSocket();const r=await this.fetchTokenAndGuardAgainstRace(e,{forceRefreshToken:!1});r.isFromOutdatedConfig||(r.value?(this.setAuthState({state:"waitingForServerConfirmationOfCachedToken",config:{fetchToken:e,onAuthChange:t},hasRetried:!1}),this.authenticate(r.value),this._logVerbose("resuming WS after auth token fetch"),this.resumeSocket()):(this.setAuthState({state:"initialRefetch",config:{fetchToken:e,onAuthChange:t}}),await this.refetchToken()))}onTransition(e){if(this.syncState.isCurrentOrNewerAuthVersion(e.endVersion.identity)&&!(e.endVersion.identity<=e.startVersion.identity)){if(this.authState.state==="waitingForServerConfirmationOfCachedToken"){this._logVerbose("server confirmed auth token is valid"),this.refetchToken(),this.authState.config.onAuthChange(!0);return}this.authState.state==="waitingForServerConfirmationOfFreshToken"&&(this._logVerbose("server confirmed new auth token is valid"),this.scheduleTokenRefetch(this.authState.token),this.authState.hadAuth||this.authState.config.onAuthChange(!0))}}onAuthError(e){const{baseVersion:t}=e;if(t!=null){if(!this.syncState.isCurrentOrNewerAuthVersion(t+1)){this._logVerbose("ignoring auth error for previous auth attempt");return}this.tryToReauthenticate(e);return}this.tryToReauthenticate(e)}async tryToReauthenticate(e){if(this.authState.state==="noAuth"||this.authState.state==="waitingForServerConfirmationOfFreshToken"){this.logger.error(`Failed to authenticate: "${e.error}", check your server auth config`),this.syncState.hasAuth()&&this.syncState.clearAuth(),this.authState.state!=="noAuth"&&this.setAndReportAuthFailed(this.authState.config.onAuthChange);return}this._logVerbose("attempting to reauthenticate"),await this.stopSocket();const t=await this.fetchTokenAndGuardAgainstRace(this.authState.config.fetchToken,{forceRefreshToken:!0});t.isFromOutdatedConfig||(t.value&&this.syncState.isNewAuth(t.value)?(this.authenticate(t.value),this.setAuthState({state:"waitingForServerConfirmationOfFreshToken",config:this.authState.config,token:t.value,hadAuth:this.authState.state==="notRefetching"||this.authState.state==="waitingForScheduledRefetch"})):(this._logVerbose("reauthentication failed, could not fetch a new token"),this.syncState.hasAuth()&&this.syncState.clearAuth(),this.setAndReportAuthFailed(this.authState.config.onAuthChange)),this.restartSocket())}async refetchToken(){if(this.authState.state==="noAuth")return;this._logVerbose("refetching auth token");const e=await this.fetchTokenAndGuardAgainstRace(this.authState.config.fetchToken,{forceRefreshToken:!0});e.isFromOutdatedConfig||(e.value?this.syncState.isNewAuth(e.value)?(this.setAuthState({state:"waitingForServerConfirmationOfFreshToken",hadAuth:this.syncState.hasAuth(),token:e.value,config:this.authState.config}),this.authenticate(e.value)):this.setAuthState({state:"notRefetching",config:this.authState.config}):(this._logVerbose("refetching token failed"),this.syncState.hasAuth()&&this.clearAuth(),this.setAndReportAuthFailed(this.authState.config.onAuthChange)),this._logVerbose("resuming WS after auth token fetch (if currently paused)"),this.resumeSocket())}scheduleTokenRefetch(e){if(this.authState.state==="noAuth")return;const t=this.decodeToken(e);if(!t){this.logger.error("Auth token is not a valid JWT, cannot refetch the token");return}const{iat:r,exp:n}=t;if(!r||!n){this.logger.error("Auth token does not have required fields, cannot refetch the token");return}const i=n-r;if(i<=2){this.logger.error("Auth token does not live long enough, cannot refetch the token");return}let o=Math.min(_t,(i-this.refreshTokenLeewaySeconds)*1e3);o<=0&&(this.logger.warn(`Refetching auth token immediately, configured leeway ${this.refreshTokenLeewaySeconds}s is larger than the token's lifetime ${i}s`),o=0);const c=setTimeout(()=>{this.refetchToken()},o);this.setAuthState({state:"waitingForScheduledRefetch",refetchTokenTimeoutId:c,config:this.authState.config}),this._logVerbose(`scheduled preemptive auth token refetching in ${o}ms`)}async fetchTokenAndGuardAgainstRace(e,t){const r=++this.configVersion,n=await e(t);return this.configVersion!==r?{isFromOutdatedConfig:!0}:{isFromOutdatedConfig:!1,value:n}}stop(){this.resetAuthState(),this.configVersion++}setAndReportAuthFailed(e){e(!1),this.resetAuthState()}resetAuthState(){this.setAuthState({state:"noAuth"})}setAuthState(e){this.authState.state==="waitingForScheduledRefetch"&&(clearTimeout(this.authState.refetchTokenTimeoutId),this.syncState.markAuthCompletion()),this.authState=e}decodeToken(e){try{return Tt(e)}catch(t){return this._logVerbose(`Error decoding token: ${t instanceof Error?t.message:"Unknown error"}`),null}}_logVerbose(e){this.logger.logVerbose(`${e} [v${this.configVersion}]`)}}const Ot=["convexClientConstructed","convexWebSocketOpen","convexFirstMessageReceived"];function Mt(s,e){const t={sessionId:e};typeof performance>"u"||!performance.mark||performance.mark(s,{detail:t})}function xt(s){let e=s.name.slice(6);return e=e.charAt(0).toLowerCase()+e.slice(1),{name:e,startTime:s.startTime}}function $t(s){if(typeof performance>"u"||!performance.getEntriesByName)return[];const e=[];for(const t of Ot){const r=performance.getEntriesByName(t).filter(n=>n.entryType==="mark").filter(n=>n.detail.sessionId===s);e.push(...r)}return e.map(xt)}var Et=Object.defineProperty,Lt=(s,e,t)=>e in s?Et(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,l=(s,e,t)=>Lt(s,typeof e!="symbol"?e+"":e,t);class Qt{constructor(e,t,r){if(l(this,"address"),l(this,"state"),l(this,"requestManager"),l(this,"webSocketManager"),l(this,"authenticationManager"),l(this,"remoteQuerySet"),l(this,"optimisticQueryResults"),l(this,"_transitionHandlerCounter",0),l(this,"_nextRequestId"),l(this,"_onTransitionFns",new Map),l(this,"_sessionId"),l(this,"firstMessageReceived",!1),l(this,"debug"),l(this,"logger"),l(this,"maxObservedTimestamp"),l(this,"mark",u=>{this.debug&&Mt(u,this.sessionId)}),typeof e=="object")throw new Error("Passing a ClientConfig object is no longer supported. Pass the URL of the Convex deployment as a string directly.");r?.skipConvexDeploymentUrlCheck!==!0&&Ie(e),r={...r};const n=r.authRefreshTokenLeewaySeconds??2;let i=r.webSocketConstructor;if(!i&&typeof WebSocket>"u")throw new Error("No WebSocket global variable defined! To use Convex in an environment without WebSocket try the HTTP client: https://docs.convex.dev/api/classes/browser.ConvexHttpClient");i=i||WebSocket,this.debug=r.reportDebugInfoToConvex??!1,this.address=e,this.logger=r.logger??ve({verbose:r.verbose??!1});const o=e.search("://");if(o===-1)throw new Error("Provided address was not an absolute URL.");const c=e.substring(o+3),a=e.substring(0,o);let d;if(a==="http")d="ws";else if(a==="https")d="wss";else throw new Error(`Unknown parent protocol ${a}`);const v=`${d}://${c}/api/${ae}/sync`;this.state=new ze,this.remoteQuerySet=new le(u=>this.state.queryPath(u),this.logger),this.requestManager=new Ye(this.logger),this.authenticationManager=new It(this.state,{authenticate:u=>{const h=this.state.setAuth(u);this.webSocketManager.sendMessage(h)},stopSocket:()=>this.webSocketManager.stop(),restartSocket:()=>this.webSocketManager.restart(),pauseSocket:()=>{this.webSocketManager.pause(),this.state.pause()},resumeSocket:()=>this.webSocketManager.resume(),clearAuth:()=>{this.clearAuth()}},{logger:this.logger,refreshTokenLeewaySeconds:n}),this.optimisticQueryResults=new it,this.addOnTransitionHandler(u=>{t(u.queries.map(h=>h.token))}),this._nextRequestId=0,this._sessionId=qt();const{unsavedChangesWarning:A}=r;if(typeof window>"u"||typeof window.addEventListener>"u"){if(A===!0)throw new Error("unsavedChangesWarning requested, but window.addEventListener not found! Remove {unsavedChangesWarning: true} from Convex client options.")}else A!==!1&&window.addEventListener("beforeunload",u=>{if(this.requestManager.hasIncompleteRequests()){u.preventDefault();const h="Are you sure you want to leave? Your changes may not be saved.";return(u||window.event).returnValue=h,h}});this.webSocketManager=new St(v,{onOpen:u=>{this.mark("convexWebSocketOpen"),this.webSocketManager.sendMessage({...u,type:"Connect",sessionId:this._sessionId,maxObservedTimestamp:this.maxObservedTimestamp});const h=new Set(this.remoteQuerySet.remoteQueryResults().keys());this.remoteQuerySet=new le(W=>this.state.queryPath(W),this.logger);const[q,x]=this.state.restart(h);x&&this.webSocketManager.sendMessage(x),this.webSocketManager.sendMessage(q);for(const W of this.requestManager.restart())this.webSocketManager.sendMessage(W)},onResume:()=>{const[u,h]=this.state.resume();h&&this.webSocketManager.sendMessage(h),u&&this.webSocketManager.sendMessage(u);for(const q of this.requestManager.resume())this.webSocketManager.sendMessage(q)},onMessage:u=>{switch(this.firstMessageReceived||(this.firstMessageReceived=!0,this.mark("convexFirstMessageReceived"),this.reportMarks()),u.type){case"Transition":{this.observedTimestamp(u.endVersion.ts),this.authenticationManager.onTransition(u),this.remoteQuerySet.transition(u),this.state.transition(u);const h=this.requestManager.removeCompleted(this.remoteQuerySet.timestamp());this.notifyOnQueryResultChanges(h);break}case"MutationResponse":{u.success&&this.observedTimestamp(u.ts);const h=this.requestManager.onResponse(u);h!==null&&this.notifyOnQueryResultChanges(new Map([[h.requestId,h.result]]));break}case"ActionResponse":{this.requestManager.onResponse(u);break}case"AuthError":{this.authenticationManager.onAuthError(u);break}case"FatalError":{const h=je(this.logger,u.error);throw this.webSocketManager.terminate(),h}}return{hasSyncedPastLastReconnect:this.hasSyncedPastLastReconnect()}}},i,this.logger),this.mark("convexClientConstructed")}hasSyncedPastLastReconnect(){return this.requestManager.hasSyncedPastLastReconnect()||this.state.hasSyncedPastLastReconnect()}observedTimestamp(e){(this.maxObservedTimestamp===void 0||this.maxObservedTimestamp.lessThanOrEqual(e))&&(this.maxObservedTimestamp=e)}getMaxObservedTimestamp(){return this.maxObservedTimestamp}notifyOnQueryResultChanges(e){const t=this.remoteQuerySet.remoteQueryResults(),r=new Map;for(const[i,o]of t){const c=this.state.queryToken(i);if(c!==null){const a={result:o,udfPath:this.state.queryPath(i),args:this.state.queryArgs(i)};r.set(c,a)}}const n=this.optimisticQueryResults.ingestQueryResultsFromServer(r,new Set(e.keys()));this.handleTransition({queries:n.map(i=>({token:i,modification:{kind:"Updated",result:r.get(i).result}})),reflectedMutations:Array.from(e).map(([i,o])=>({requestId:i,result:o})),timestamp:this.remoteQuerySet.timestamp()})}handleTransition(e){for(const t of this._onTransitionFns.values())t(e)}addOnTransitionHandler(e){const t=this._transitionHandlerCounter++;return this._onTransitionFns.set(t,e),()=>this._onTransitionFns.delete(t)}setAuth(e,t){this.authenticationManager.setConfig(e,t)}hasAuth(){return this.state.hasAuth()}setAdminAuth(e,t){const r=this.state.setAdminAuth(e,t);this.webSocketManager.sendMessage(r)}clearAuth(){const e=this.state.clearAuth();this.webSocketManager.sendMessage(e)}subscribe(e,t,r){const n=S(t),{modification:i,queryToken:o,unsubscribe:c}=this.state.subscribe(e,n,r?.journal,r?.componentPath);return i!==null&&this.webSocketManager.sendMessage(i),{queryToken:o,unsubscribe:()=>{const a=c();a&&this.webSocketManager.sendMessage(a)}}}localQueryResult(e,t){const r=S(t),n=C(e,r);return this.optimisticQueryResults.queryResult(n)}localQueryResultByToken(e){return this.optimisticQueryResults.queryResult(e)}hasLocalQueryResultByToken(e){return this.optimisticQueryResults.hasQueryResult(e)}localQueryLogs(e,t){const r=S(t),n=C(e,r);return this.optimisticQueryResults.queryLogs(n)}queryJournal(e,t){const r=S(t),n=C(e,r);return this.state.queryJournal(n)}connectionState(){return{hasInflightRequests:this.requestManager.hasInflightRequests(),isWebSocketConnected:this.webSocketManager.socketState()==="ready",timeOfOldestInflightRequest:this.requestManager.timeOfOldestInflightRequest()}}async mutation(e,t,r){const n=await this.mutationInternal(e,t,r);if(!n.success)throw n.errorData!==void 0?ee(n,new K(I("mutation",e,n))):new Error(I("mutation",e,n));return n.value}async mutationInternal(e,t,r,n){const{mutationPromise:i}=this.enqueueMutation(e,t,r,n);return i}enqueueMutation(e,t,r,n){const i=S(t);this.tryReportLongDisconnect();const o=this.nextRequestId;if(this._nextRequestId++,r!==void 0){const v=r.optimisticUpdate;if(v!==void 0){const A=q=>{v(q,i)},h=this.optimisticQueryResults.applyOptimisticUpdate(A,o).map(q=>{const x=this.localQueryResultByToken(q);return{token:q,modification:{kind:"Updated",result:x===void 0?void 0:{success:!0,value:x,logLines:[]}}}});this.handleTransition({queries:h,reflectedMutations:[],timestamp:this.remoteQuerySet.timestamp()})}}const c={type:"Mutation",requestId:o,udfPath:e,componentPath:n,args:[T(i)]},a=this.webSocketManager.sendMessage(c),d=this.requestManager.request(c,a);return{requestId:o,mutationPromise:d}}async action(e,t){const r=await this.actionInternal(e,t);if(!r.success)throw r.errorData!==void 0?ee(r,new K(I("action",e,r))):new Error(I("action",e,r));return r.value}async actionInternal(e,t,r){const n=S(t),i=this.nextRequestId;this._nextRequestId++,this.tryReportLongDisconnect();const o={type:"Action",requestId:i,udfPath:e,componentPath:r,args:[T(n)]},c=this.webSocketManager.sendMessage(o);return this.requestManager.request(o,c)}async close(){return this.authenticationManager.stop(),this.webSocketManager.terminate()}get url(){return this.address}get nextRequestId(){return this._nextRequestId}get sessionId(){return this._sessionId}reportMarks(){if(this.debug){const e=$t(this.sessionId);this.webSocketManager.sendMessage({type:"Event",eventType:"ClientConnect",event:e})}}tryReportLongDisconnect(){if(!this.debug)return;const e=this.connectionState().timeOfOldestInflightRequest;if(e===null||Date.now()-e.getTime()<=60*1e3)return;const t=`${this.address}/api/debug_event`;fetch(t,{method:"POST",headers:{"Content-Type":"application/json","Convex-Client":`npm-${ae}`},body:JSON.stringify({event:"LongWebsocketDisconnect"})}).then(r=>{r.ok||this.logger.warn("Analytics request failed with response:",r.body)}).catch(r=>{this.logger.warn("Analytics response failed with error:",r)})}}var Pt=Object.defineProperty,Vt=(s,e,t)=>e in s?Pt(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,R=(s,e,t)=>Vt(s,typeof e!="symbol"?e+"":e,t);if(typeof se>"u")throw new Error("Required dependency 'react' not found");if(typeof ge>"u")throw new Error("Required dependency 'react-dom' not found");class Xt{constructor(e,t){if(R(this,"address"),R(this,"cachedSync"),R(this,"listeners"),R(this,"options"),R(this,"closed",!1),R(this,"_logger"),R(this,"adminAuth"),R(this,"fakeUserIdentity"),e===void 0)throw new Error("No address provided to ConvexReactClient.\nIf trying to deploy to production, make sure to follow all the instructions found at https://docs.convex.dev/production/hosting/\nIf running locally, make sure to run `convex dev` and ensure the .env.local file is populated.");if(typeof e!="string")throw new Error(`ConvexReactClient requires a URL like 'https://happy-otter-123.convex.cloud', received something of type ${typeof e} instead.`);if(!e.includes("://"))throw new Error("Provided address was not an absolute URL.");this.address=e,this.listeners=new Map,this._logger=t?.logger??ve({verbose:t?.verbose??!1}),this.options={...t,logger:this._logger}}get sync(){if(this.closed)throw new Error("ConvexReactClient has already been closed.");return this.cachedSync?this.cachedSync:(this.cachedSync=new Qt(this.address,e=>this.transition(e),this.options),this.adminAuth&&this.cachedSync.setAdminAuth(this.adminAuth,this.fakeUserIdentity),this.cachedSync)}setAuth(e,t){if(typeof e=="string")throw new Error("Passing a string to ConvexReactClient.setAuth is no longer supported, please upgrade to passing in an async function to handle reauthentication.");this.sync.setAuth(e,t??(()=>{}))}clearAuth(){this.sync.clearAuth()}setAdminAuth(e,t){if(this.adminAuth=e,this.fakeUserIdentity=t,this.closed)throw new Error("ConvexReactClient has already been closed.");this.cachedSync&&this.sync.setAdminAuth(e,t)}watchQuery(e,...t){const[r,n]=t,i=m(e);return{onUpdate:o=>{const{queryToken:c,unsubscribe:a}=this.sync.subscribe(i,r,n),d=this.listeners.get(c);return d!==void 0?d.add(o):this.listeners.set(c,new Set([o])),()=>{if(this.closed)return;const v=this.listeners.get(c);v.delete(o),v.size===0&&this.listeners.delete(c),a()}},localQueryResult:()=>{if(this.cachedSync)return this.cachedSync.localQueryResult(i,r)},localQueryLogs:()=>{if(this.cachedSync)return this.cachedSync.localQueryLogs(i,r)},journal:()=>{if(this.cachedSync)return this.cachedSync.queryJournal(i,r)}}}mutation(e,...t){const[r,n]=t,i=m(e);return this.sync.mutation(i,r,n)}action(e,...t){const r=m(e);return this.sync.action(r,...t)}query(e,...t){const r=this.watchQuery(e,...t),n=r.localQueryResult();return n!==void 0?Promise.resolve(n):new Promise((i,o)=>{const c=r.onUpdate(()=>{c();try{i(r.localQueryResult())}catch(a){o(a)}})})}connectionState(){return this.sync.connectionState()}get logger(){return this._logger}async close(){if(this.closed=!0,this.listeners=new Map,this.cachedSync){const e=this.cachedSync;this.cachedSync=void 0,await e.close()}}transition(e){ge.unstable_batchedUpdates(()=>{for(const t of e){const r=this.listeners.get(t);if(r)for(const n of r)n()}})}}const qe=se.createContext(void 0);function Ft(){return k.useContext(qe)}const Gt=({client:s,children:e})=>se.createElement(qe.Provider,{value:s},e);function Yt(s,...e){const t=e[0]==="skip",r=e[0]==="skip"?{}:S(e[0]),n=typeof s=="string"?st(s):s,i=m(n),o=k.useMemo(()=>t?{}:{query:{query:n,args:r}},[JSON.stringify(T(r)),i,t]),a=Wt(o).query;if(a instanceof Error)throw a;return a}var Nt=Object.defineProperty,Bt=(s,e,t)=>e in s?Nt(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,G=(s,e,t)=>Bt(s,typeof e!="symbol"?e+"":e,t);class Ut{constructor(e){G(this,"createWatch"),G(this,"queries"),G(this,"listeners"),this.createWatch=e,this.queries={},this.listeners=new Set}setQueries(e){for(const t of Object.keys(e)){const{query:r,args:n}=e[t];if(m(r),this.queries[t]===void 0)this.addQuery(t,r,n);else{const i=this.queries[t];(m(r)!==m(i.query)||JSON.stringify(T(n))!==JSON.stringify(T(i.args)))&&(this.removeQuery(t),this.addQuery(t,r,n))}}for(const t of Object.keys(this.queries))e[t]===void 0&&this.removeQuery(t)}subscribe(e){return this.listeners.add(e),()=>{this.listeners.delete(e)}}getLocalResults(e){const t={};for(const r of Object.keys(e)){const{query:n,args:i}=e[r];m(n);const o=this.createWatch(n,i);let c;try{c=o.localQueryResult()}catch(a){if(a instanceof Error)c=a;else throw a}t[r]=c}return t}setCreateWatch(e){this.createWatch=e;for(const t of Object.keys(this.queries)){const{query:r,args:n,watch:i}=this.queries[t],o=i.journal();this.removeQuery(t),this.addQuery(t,r,n,o)}}destroy(){for(const e of Object.keys(this.queries))this.removeQuery(e);this.listeners=new Set}addQuery(e,t,r,n){if(this.queries[e]!==void 0)throw new Error(`Tried to add a new query with identifier ${e} when it already exists.`);const i=this.createWatch(t,r,n),o=i.onUpdate(()=>this.notifyListeners());this.queries[e]={query:t,args:r,watch:i,unsubscribe:o}}removeQuery(e){const t=this.queries[e];if(t===void 0)throw new Error(`No query found with identifier ${e}.`);t.unsubscribe(),delete this.queries[e]}notifyListeners(){for(const e of this.listeners)e()}}function Dt({getCurrentValue:s,subscribe:e}){const[t,r]=k.useState(()=>({getCurrentValue:s,subscribe:e,value:s()}));let n=t.value;return(t.getCurrentValue!==s||t.subscribe!==e)&&(n=s(),r({getCurrentValue:s,subscribe:e,value:n})),k.useEffect(()=>{let i=!1;const o=()=>{i||r(a=>{if(a.getCurrentValue!==s||a.subscribe!==e)return a;const d=s();return a.value===d?a:{...a,value:d}})},c=e(o);return o(),()=>{i=!0,c()}},[s,e]),n}function Wt(s){const e=Ft();if(e===void 0)throw new Error("Could not find Convex client! `useQuery` must be used in the React component tree under `ConvexProvider`. Did you forget it? See https://docs.convex.dev/quick-start#set-up-convex-in-your-react-app");const t=k.useMemo(()=>(r,n,i)=>e.watchQuery(r,n,{journal:i}),[e]);return jt(s,t)}function jt(s,e){const[t]=k.useState(()=>new Ut(e));t.createWatch!==e&&t.setCreateWatch(e),k.useEffect(()=>()=>t.destroy(),[t]);const r=k.useMemo(()=>({getCurrentValue:()=>t.getLocalResults(s),subscribe:n=>(t.setQueries(s),t.subscribe(n))}),[t,s]);return Dt(r)}export{Xt as C,Gt as a,zt as b,Yt as u};
